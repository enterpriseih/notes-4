# 什么是拆包与粘包

假设客户端向服务端连续发送了两个数据包，用 packet1 和 packet2 来表示，那么服务端收到的数据可以分为三种，现列举如下

- 第一种：服务端正常接收到这两个数据包 package1 和 package2，即没有发生拆包和粘包
- 第二种：接收端只接收到一个包，由于tcp不会出现丢包的现象。所以这一个数据包中包含了发送端发送的两个数据包的信息，这种现象即为粘包。这种情况由于接收端不知道这两个数据包的界限，所以对于接收端来说很难处理。
- 第三种：这种情况有两种表现形式，接收端收到了两个数据包，但是这两个数据包一个少一块，一个多一块，这种情况即发生了拆包和粘包。（package1不完整，package2多了package1一部分；或者package1多了package2的一部分，package2不完整）

# 消息的变化

<img src="https://cdn.jsdelivr.net/gh/YiENx1205/cloudimgs/notes/202208081522264.png" alt="图片" style="zoom:67%;" />

四层网络模型每层各司其职，消息在进入每一层时都会多加一个**报头**，每多一个报头可以理解为**数据报多戴一顶帽子**。这个报头上面记录着消息从哪来，到哪去，以及消息多长等信息。比如，**`mac头`记录的是硬件的唯一地址，`IP头`记录的是从哪来和到哪去，`tcp头`记录到是到达目的主机后具体去哪个进程（端口）**。



# [TCP分段和IP分片](https://mp.weixin.qq.com/s/YpQGsRyyrGNDu1cOuMy83w)

网络像一根管子，管子有粗细，数据包大小不定，要经过管子，数据包就不能大于管子粗细程度，当数据包过大时，就会将其切分。

数据先过传输层，再到网络层。

这个行为在**传输层和网络层**都有可能发生。

在传输层（`TCP`协议）里，叫**分段**。

在网络层（`IP`层），叫**分片**。（注意以下提到的IP没有特殊说明的情况下，都是指**IPV4**）

那么不管是分片还是分段，肯定需要**按照一定的长度**切分。

在`TCP`里，这个长度是`MSS`。在`IP`层里，这个长度是`MTU`。

- **MTU**: Maximum Transmit Unit，最大传输单元。一般 MTU = 1500 Byte。

- **MSS**：Maximum Segment Size，最大分段大小。

<img src="https://cdn.jsdelivr.net/gh/YiENx1205/cloudimgs/notes/202208081533334.png" alt="图片" style="zoom:80%;" />

假设 MTU= 1500 byte，那么 **MSS = 1500- 20(IP Header) -20 (TCP Header) = 1460 byte**，如果应用层有 **2000 byte** 发送，那么需要两个切片才可以完成发送，第一个 TCP 切片 = 1460，第二个 TCP 切片 = 540。

个人理解：因为最终会到IP层，所以最终发出去的都以片为单位了。

# 为什么会发生粘包和拆包？

可以发生拆包、粘包原理是因为TCP是基于字节流传输的，字节流的0和1没有界限。

- **滑动窗口**
	- 粘包：假设发送方的每256 bytes表示一个完整的报文，接收方由于数据处理不及时，这256个字节的数据都会被缓存到接收缓存区中。如果接收方的接收缓存区中缓存了多个报文，那么对于接收方而言，这就是粘包。
	- 拆包：考虑另外一种情况，假设接收方的窗口只剩了128，意味着发送方最多还可以发送128字节，而由于发送方的数据大小是256字节，因此只能发送前128字节，等到接收方ack后，才能发送剩余字节。这就造成了拆包。
- **MTU/MSS的限制**
- **Nagle算法**：避免数据过小，而产生多个包传输，会将多个小包整合成一个大包。
	- 目前基本都是关闭的，因为网络效率高了，不需要这样做了。
	- 关闭后，如果接收方没有及时取走，还是会发生粘包，即两个消息挤在一起，然后再一起取走。

# 解决办法

加入消息头尾标记位、消息长度、校验字段（判断是否为一个完整消息）。



---

- [参考](https://mp.weixin.qq.com/s?__biz=Mzg5NDY2MDk4Mw==&mid=2247486377&idx=1&sn=bdc4b8b71559193b29aa0f54b95973db&chksm=c01d73b1f76afaa708145a0d9af91de719cf7d0beb4c2945319bbd6d7a1a017bb03833c84b9c&scene=126&&sessionid=1659942401#rd)