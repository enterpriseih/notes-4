# 秒杀系统

特点：瞬时流量大，秒杀商品库存少，静态资源访问多（秒杀时间来临前刷新量大）

1. 高并发

2. 防止超卖：大量并发扣减库存，导致库存变负。

3. 防刷子：恶意刷单等，抢占订单。限流。

4. 页面资源访问多：考虑页面静态化，CDN，静态资源缓存及压缩。

5. 秒杀按钮：通过前端按钮置灰。

6. 秒杀真链接隐藏：防止后台交互链接，非秒杀期间漏出。

7. 异步处理订单后续：秒杀成功后，订单处理交于异步服务。

8. 订单失败补偿：遇到订单后续处理失败，必须补偿。

9. 服务降级：遇到紧急情况，可以快速处理。



### 1、针对高并发

上线前做好测压，知道服务qps瓶颈点，针对日常业务秒杀多预估，进行服务器多准备。

测量tps，寻找薄弱点进行代码优化，服务支撑优化。

一般采用redis+热数据+mq，集群负载均衡。前端静态化+cdn加速。

### 2、防止超卖

秒杀前，将库存同步到redis。

借助分布式锁和lua脚本来保证库存扣减的原子性。

### 3、限流防刷子

一种是用户ID限流，一种是ip进行限流。

### 4、页面资源静态化

url唯一化处理，对页面资源提前进行缓存，保证用户直接请求url对时候，无需去解析请求头，无需重组http协议，可直接找到静态资源进行返回，不与后端做数据交互。

一般静态化要放在cdn上，cdn的就近原则可以提高响应速度和命中率。

同时cdn开启资源压缩，减少传输速度。

### 5、秒杀真链接隐藏

防止刷子在秒杀开始之前知道真正的请求链接，通过机器等方式进行提前请求。

采取链接加密，每次秒杀都无规律可言，只有时间到了才能看到真实的秒杀地址。

### 6、异步处理订单

消息队列

用户参与秒杀成功后，不应该同步返回用户秒杀结果，而是交给消息队列，交由其他服务进行后续的负责处理，直接返回给用户秒杀成功。

随着用户点击查看订单的过程，后端其实已经处理完毕。

### 7、服务降级

下下策。

由于服务确实出现了问题，导致秒杀业务不能正常进行。比如，秒杀价格错误。

为了及时止损，要做一个降级开关，不做任何交互，直接返回一些提示文案（比如，秒杀结束）。

还有可能是服务器撑不住了，也需要进行降级。